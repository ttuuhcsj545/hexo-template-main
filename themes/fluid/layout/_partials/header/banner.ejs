<%
  // 随机选择远程背景图编号
  var randomNum = Math.floor(Math.random() * 651) + 1;
  var random123 = Math.floor(Math.random() * 14) + 1;

  // 默认远程图（国外）
  var foreign_img = 'https://ttuuhcsj545.github.io/txt/images/pc/' + randomNum + '.webp';

  // 本地备用图（Hexo 本地资源）
  var fallback_img = '/image/wallpaper/background' + random123 + '.webp';

  var banner_img_height = parseFloat(page.banner_img_height || theme.index.banner_img_height);
  var banner_mask_alpha = parseFloat(page.banner_mask_alpha || theme.index.banner_mask_alpha);
  var subtitle = page.subtitle || page.title;
%>

<!-- 把 style 的 background 去掉，只保留 class -->
<div id="banner" class="banner" <%- theme.banner && theme.banner.parallax && 'parallax=true' %>>
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, <%= banner_mask_alpha %>)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          <% if(theme.fun_features.typing.enable && in_scope(theme.fun_features.typing.scope)) { %>
            <span id="subtitle" data-typed-text="<%= subtitle %>"></span>
          <% } else { %>
            <span id="subtitle"><%- subtitle %></span>
          <% } %>
        </div>

        <% if (is_post()) { %>
          <%- inject_point('postMetaTop') %>
        <% } %>
      </div>

      <% if (theme.scroll_down_arrow.enable && theme.scroll_down_arrow.banner_height_limit <= banner_img_height && page.layout !== '404') { %>
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script>
  (function () {
    const bannerEl = document.getElementById('banner');
    const randomNum = <%= randomNum %>;
    const random123 = <%= random123 %>;

    const fallbackImg = "/image/wallpaper/background" + random123 + ".webp";
    const foreignImg = "https://ttuuhcsj545.github.io/txt/images/pc/" + randomNum + ".webp";
    const localImg = "https://gitee.com/internasxs/txt/raw/main/images/pc/" + randomNum + ".webp";

    window.isDomesticUser = null;

    async function detectUserRegionAndSetBackground() {
      let selectedImg = foreignImg;

      try {
        const res = await fetch('https://ipinfo.liiiil.dpdns.org/');
        const text = await res.text();
        window.isDomesticUser = text.trim() === 'true';
        console.log('地区检测结果：', window.isDomesticUser);

        if (window.isDomesticUser) {
          selectedImg = localImg;
        }
      } catch (e) {
        console.error('地区检测失败，默认使用国外资源');
      }

      const img = new Image();

      img.onload = function () {
        bannerEl.style.background = `url('${selectedImg}') no-repeat center center`;
        bannerEl.style.backgroundSize = 'cover';
      };

      img.onerror = function () {
        bannerEl.style.background = `url('${fallbackImg}') no-repeat center center`;
        bannerEl.style.backgroundSize = 'cover';
        console.warn('背景图加载失败，已切换备用图');
      };

      img.src = selectedImg;
    }

    detectUserRegionAndSetBackground();
  })();
</script>